deploy:
  needs: sonar-analysis
  runs-on: ubuntu-latest
  if: success()
  steps:
    - name: Deploy remoto via SSH (sem docker-compose)
      uses: appleboy/ssh-action@master
      with:
        host: 201.23.3.86
        username: aluno
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "Criando rede docker se não existir..."
          docker network create vivi-net || true

          echo "Parando e removendo containers antigos..."
          docker stop vivi-mysql || true
          docker rm -f vivi-mysql || true
          docker stop vinicius || true
          docker rm -f vinicius || true

          echo "Verificando se porta 8240 está livre..."
          PORT_OCCUPIED=$(ss -tulpn | grep ':8240 ')
          if [ -n "$PORT_OCCUPIED" ]; then
            echo "Porta 8240 está ocupada. Tentando liberar..."

            # Busca PID do docker-proxy que pode estar segurando a porta
            PID=$(ps aux | grep 'docker-proxy' | grep '8240' | awk '{print $2}')
            if [ -n "$PID" ]; then
              echo "Matando processo docker-proxy com PID $PID"
              kill -9 $PID
            else
              echo "Nenhum processo docker-proxy encontrado na porta 8240"
            fi

            echo "Verificando novamente a porta..."
            PORT_OCCUPIED=$(ss -tulpn | grep ':8240 ' || true)
            if [ -n "$PORT_OCCUPIED" ]; then
              echo "Porta 8240 ainda ocupada. Reiniciando Docker..."
              sudo systemctl restart docker
              sleep 10
            else
              echo "Porta 8240 liberada com sucesso"
            fi
          else
            echo "Porta 8240 está livre."
          fi

          echo "Subindo container MySQL..."
          docker run -d --name vivi-mysql --network vivi-net -e MYSQL_ROOT_PASSWORD=senha -e MYSQL_DATABASE=meubanco -p 8239:3306 mysql:8.0

          echo "Aguardando MySQL ficar pronto..."
          until docker exec vivi-mysql mysqladmin ping -h "127.0.0.1" --silent; do
            echo "Esperando MySQL iniciar..."
            sleep 5
          done

          echo "Baixando última imagem do app..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/vivi:latest

          echo "Subindo container app..."
          docker run -d --name vinicius --network vivi-net \
            -e DB_HOST=vivi-mysql -e DB_USER=root -e DB_PASSWORD=senha -e DB_NAME=meubanco \
            -p 8240:5000 ${{ secrets.DOCKERHUB_USERNAME }}/vivi:latest

          echo "Logs MySQL:"
          docker logs vivi-mysql --tail 50

          echo "Logs do app:"
          docker logs vinicius --tail 50

          echo "Verificando status do container app..."
          status=$(docker inspect --format='{{.State.ExitCode}}' vinicius)
          if [ "$status" != "0" ]; then
            echo "Erro: container vinicius saiu com exit code $status"
            docker logs vinicius
            exit 1
          fi
